{# Render uplift related information related to this revision.

At the moment, this only includes a reference to the uplift request
assessment for the stack, but will include more details in the
future.
#}
{% macro revision_tag(rev_id, current_revision_id) %}
    {% if rev_id == current_revision_id %}
        <span class="tag is-primary">D{{ rev_id }}</span>
    {% else %}
        <a class="tag is-link" href="{{ url('revisions-page', args=[rev_id]) }}">D{{ rev_id }}</a>
    {% endif %}
{% endmacro %}
<h1>Uplifts</h1>
{% if revision_repo and revision_repo.approval_required %}
    {% set has_uplift_assessment = uplift_assessment_form.instance.pk is not none %}
    <div class="block">
        <div class="block">
            <div class="columns is-mobile is-vcentered is-multiline">
                <div class="column is-narrow">
                    <button class="button is-primary edit-assessment-open">
                        <span class="icon is-small">
                            <i class="fa fa-pencil-square-o" aria-hidden="true"></i>
                        </span>
                        <span>
                            {% if has_uplift_assessment %}
                                Edit Uplift Assessment
                            {% else %}
                                Submit Uplift Assessment
                            {% endif %}
                        </span>
                    </button>
                </div>
                {% if uplift_assessment_link_form %}
                    <div class="column is-narrow">
                        <button class="button is-light link-assessment-open"
                                {% if not uplift_assessment_link_form.has_assessments %}disabled{% endif %}
                                title="{% if not uplift_assessment_link_form.has_assessments %}You have no previous uplift assessments to link{% endif %}">
                            <span class="icon is-small">
                                <i class="fa fa-link" aria-hidden="true"></i>
                            </span>
                            <span>
                                {% if has_uplift_assessment %}
                                    Change Linked Assessment
                                {% else %}
                                    Link Existing Assessment
                                {% endif %}
                            </span>
                        </button>
                    </div>
                {% endif %}
                <div class="column">
                    {% if uplift_assessment_form.instance.pk %}
                        <span class="has-text-success">
                            <span class="icon is-small">
                                <i class="fa fa-check-circle" aria-hidden="true"></i>
                            </span>
                            <span>Uplift assessment submitted for this revision.</span>
                        </span>
                    {% else %}
                        <span class="has-text-grey">
                            <span class="icon is-small">
                                <i class="fa fa-exclamation-circle" aria-hidden="true"></i>
                            </span>
                            <span>No uplift assessment submitted yet.</span>
                        </span>
                    {% endif %}
                </div>
            </div>
            {% if uplift_assessment_link_form and not uplift_assessment_link_form.has_assessments %}
                <p class="has-text-grey is-size-7 mt-2">You have no previous uplift assessments to link for this account.</p>
            {% endif %}
        </div>
    </div>
    <div class="uplift-assessment-edit-modal modal">
        <form action="{{ url('uplift-assessment-page', args=[revision_id_int]) }}"
              method="post">
            <div class="modal-background"></div>
            <div class="modal-card">
                <header class="modal-card-head">
                    <p class="modal-card-title">Edit Assessment</p>
                    <button class="edit-assessment-close delete" aria-label="close" type="button"></button>
                </header>
                <section class="modal-card-body">
                    {{ csrf_input }}
                    {% if not user_has_phabricator_token %}
                        {% include "stack/partials/uplift-phab-api-key-warning.html" %}
                    {% endif %}
                    {% with assessment_form = uplift_assessment_form %}
                        {% include "stack/partials/uplift-assessment.html" %}
                    {% endwith %}
                </section>
                {% set can_edit_assessment = user_is_authenticated and user_has_phabricator_token %}
                <footer class="modal-card-foot">
                    <button class="button is-primary"
                            {% if not can_edit_assessment %}disabled{% endif %}
                            title="{% if not can_edit_assessment %}Editing the assessment is blocked. See the error messages above for more detail.{% else %}Save responses{% endif %}">
                        Update assessment form
                    </button>
                </footer>
            </div>
        </form>
    </div>
    {% if uplift_assessment_link_form %}
        <div class="uplift-assessment-link-modal modal">
            <form action="{{ url('uplift-assessment-link-page', args=[revision_id_int]) }}"
                  method="post">
                <div class="modal-background"></div>
                <div class="modal-card">
                    <header class="modal-card-head">
                        <p class="modal-card-title">Link Existing Assessment</p>
                        <button class="link-assessment-close delete" aria-label="close" type="button"></button>
                    </header>
                    <section class="modal-card-body">
                        {{ csrf_input }}
                        <p class="block">
                            Link this revision to a previous uplift assessment so you do not have to re-enter the same answers.
                            Choose the matching assessment you submitted earlier; you can still edit it after linking if details changed.
                        </p>
                        <div class="field">
                            <label class="label"
                                   for="{{ uplift_assessment_link_form.assessment.id_for_label }}">
                                Existing uplift assessment
                            </label>
                            <div class="control">
                                <div class="select is-fullwidth">{{ uplift_assessment_link_form.assessment }}</div>
                            </div>
                            {% if uplift_assessment_link_form.assessment.help_text %}
                                <p class="help">{{ uplift_assessment_link_form.assessment.help_text }}</p>
                            {% endif %}
                        </div>
                    </section>
                    <footer class="modal-card-foot">
                        <button class="button is-primary"
                                {% if not uplift_assessment_link_form.has_assessments %}disabled{% endif %}>
                            Link assessment
                        </button>
                        <button class="button link-assessment-close" type="button">Cancel</button>
                    </footer>
                </div>
            </form>
        </div>
    {% endif %}
{% endif %}
{% if uplift_requests %}
    <div class="Uplifts">
        {% for uplift_request in uplift_requests %}
            <div class="box">
                <div class="level is-mobile">
                    <div class="level-left">
                        <div class="level-item">
                            <div>
                                <div class="is-size-6 has-text-weight-semibold">Uplift request</div>
                                <p class="is-size-7 has-text-grey">
                                    <time data-timestamp="{{ uplift_request.created_at }}"></time>, by {{ uplift_request.requested_by.email }}.
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="level-right">
                        <div class="level-item">
                            <div class="has-text-right">
                                <p class="is-size-7 has-text-grey">Requested revisions</p>
                                <div class="tags is-right">
                                    {% for rev_id in uplift_request.requested_revision_ids %}{{ revision_tag(rev_id, revision_id_int) }}{% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {# Jobs list. #}
                <div class="content">
                    {% for job in uplift_request.uplift_jobs.all() %}
                        {% if not loop.first %}<hr>{% endif %}
                        <article class="media">
                            {% set tag_class = job|uplift_status_tag_class %}
                            {% set icon_class = job|uplift_status_icon_class %}
                            {% set status_label = job|uplift_status_label %}
                            <figure class="media-left">
                                <span class="tag {{ tag_class }}">
                                    {% if icon_class %}
                                        <span class="icon is-small">
                                            <i class="{{ icon_class }}" aria-hidden="true"></i>
                                        </span>
                                    {% endif %}
                                </span>
                            </figure>
                            <div class="media-content">
                                <div class="columns is-mobile is-vcentered is-multiline">
                                    <div class="column">
                                        <div class="is-size-6 has-text-weight-semibold">{{ job.target_repo.name }}</div>
                                        <div class="content">
                                            <p>
                                                <strong>{{ status_label }}</strong>
                                            </p>
                                            {% if job.error %}
                                                <div>
                                                    <button type="button" class="button is-small is-light toggle-content">Show error details</button>
                                                </div>
                                                <div class="hidden-content has-text-left">
                                                    {% include "partials/error-breakdown.html" %}
                                                    <pre><strong>Raw error output:</strong>{{ "\n" + job.error }}</pre>
                                                    <button type="button" class="button is-small is-light toggle-content">Hide error details</button>
                                                </div>
                                            {% endif %}
                                            {% if job.created_revision_ids %}
                                                <div class="content">
                                                    <div class="tags">
                                                        {% for rev_id in job.created_revision_ids %}{{ revision_tag(rev_id, revision_id_int) }}{% endfor %}
                                                    </div>
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="column is-narrow has-text-right">
                                        <a class="button is-small is-light"
                                           href="{{ url('uplift-jobs-page', args=[job.id]) }}">View job</a>
                                    </div>
                                </div>
                            </div>
                        </article>
                    {% else %}
                        <p class="has-text-grey">No jobs found for this request.</p>
                    {% endfor %}
                </div>
            </div>
        {% endfor %}
    </div>
{% endif %}
